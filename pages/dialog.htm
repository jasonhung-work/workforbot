<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="/css/botchat.css" rel="stylesheet" />
    <link href="/css/bootstrap/bootstrap.css" rel="stylesheet" />
    <link href="/css/font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/css/bootstrap/dataTables.bootstrap.css" rel="stylesheet" />
    <link href="/css/jquery-ui/jquery-ui.css" rel="stylesheet">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>流程編輯器</title>
    <style type="text/css">
        body {
            padding: 10px;
            font-family: consolas;
        }

        .modal.modal-wide .modal-dialog {
            width: 90%;
        }

        .modal-wide .modal-body {
            overflow-y: auto;
        }

        .modal.modal-middle .modal-dialog {
            width: 60%;
        }

        .modal-middle .modal-body {
            overflow-y: auto;
        }

        table.dataTable thead .sorting,
        table.dataTable thead .sorting_asc,
        table.dataTable thead .sorting_desc,
        table.dataTable thead .sorting_asc_disabled,
        table.dataTable thead .sorting_desc_disabled {
            background: 0 0;
        }

        table.dataTable thead .sorting_asc:after {
            content: "\f0de";
            float: right;
            font-family: fontawesome;
        }

        table.dataTable thead .sorting_desc:after {
            content: "\f0dd";
            float: right;
            font-family: fontawesome;
        }

        table.dataTable thead .sorting:after {
            content: "\f0dc";
            float: right;
            font-family: fontawesome;
            color: rgba(50, 50, 50, .5);
        }

        .border-highlight {
            border-width: 2px;
            border-color: orange;
            border-style: solid;
        }
    </style>
    <script type="text/javascript" src="/scripts/jquery/jquery-1.9.0.min.js"></script>
    <script type="text/javascript" src="/scripts/jquery-ui/jquery-ui.js"></script>
    <script type="text/javascript" src="/scripts/bootstrap/bootstrap.min.js"></script>
    <script type="text/javascript" src="/scripts/bootstrap/bootbox/bootbox.min.js"></script>
    <script type="text/javascript" src="/scripts/bootstrap/bootstrapValidator/bootstrapValidator.min.js"></script>
    <script type="text/javascript" src="/scripts/bootstrap/dataTables/jquery.dataTables.js"></script>
    <script type="text/javascript" src="/scripts/bootstrap/dataTables/dataTables.bootstrap.js"></script>
    <script type="text/javascript" src="/scripts/Hashtable.js"></script>
    <script type="text/javascript">
        var Dialogs = [];
        var Locale = 'tw';
        var Locales = [];
        var Variables = new $.Hashtable();
        var $MainTable;
        var $VariableTable;
        var $MessageTable;
        var Socket;
        var DeleteMode = false;
        var auto_message = -1;

        $(document).ready(function () {
            $('h1[name="title"]').text($('h1[name="title"]').text() + FlowDescription);
            RefreshVariable();
            Refresh();

            $('#DivWebAPI').find('[name="Method"]').change(function () {
                if ($(this).val() == 'post' || $(this).val() == 'put' || $(this).val() == 'delete') {
                    $('#BtnParams').removeClass('hidden');
                } else {
                    $('#BtnParams').addClass('hidden');
                }
            });
            $('#DivCondition').find('[name="TargetType"]').change(function () {
                if ($(this).val() == 'Const') {
                    $('#DivCondition').find('input[name="TargetField"]').removeClass('hidden');
                    $('#DivCondition').find('select[name="TargetField"]').addClass('hidden');
                } else {
                    $('#DivCondition').find('input[name="TargetField"]').addClass('hidden');
                    $('#DivCondition').find('select[name="TargetField"]').removeClass('hidden');
                }
            });

            $('#TxtNext').change(function () {
                $('#DivTransfer').addClass('hidden');
                if ($(this).val() == '-3') {
                    $('#DivTransfer').removeClass('hidden');
                }
            });

            $('#TxtType').change(function () {
                $('[id^="Template"').addClass('hidden');
                $('#TxtField').prop('disabled', false);
                $('#DivNext').addClass('hidden');
                $('#DivTransfer').addClass('hidden');
                if ($(this).val() == 'text') {
                    $('#DivNext').removeClass('hidden');
                    TargetDialog = { 'dialog_id': TargetDialog.dialog_id, 'type': 'text', 'field': '', 'prompt': '顯示的文字', next: 0 };
                    $('#TxtField').prop('disabled', true);
                } else if ($(this).val() == 'input') {
                    $('#DivNext').removeClass('hidden');
                    TargetDialog = { 'dialog_id': TargetDialog.dialog_id, 'type': 'input', 'field': '', 'prompt': '顯示的文字', next: 0 };
                } else if ($(this).val() == 'card') {
                    $('#DivNext').removeClass('hidden');
                    TargetDialog = {
                        'dialog_id': TargetDialog.dialog_id, 'type': 'card', 'field': '', 'prompt': {
                            'attachments': [
                                {
                                    'contentType': 'application/vnd.microsoft.card.hero',
                                    'content': {
                                        'title': '標題文字',
                                        'subtitle': '顯示的文字'
                                    }
                                }
                            ]
                        }
                    };
                } else if ($(this).val() == 'choice') {
                    TargetDialog = {
                        'dialog_id': TargetDialog.dialog_id, 'type': 'choice', 'field': '', 'prompt': {
                            'attachments': [
                                {
                                    'contentType': 'application/vnd.microsoft.card.hero',
                                    'content': {
                                        'title': '標題文字',
                                        'subtitle': '顯示的文字',
                                        'buttons': [
                                            {
                                                'type': 'postBack',
                                                'title': '按鈕',
                                                'value': 'Button',
                                                'dialog_id': 0
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    };
                } else if ($(this).val() == 'confirm') {
                    TargetDialog = {
                        'dialog_id': TargetDialog.dialog_id, 'type': 'confirm', 'field': '', 'prompt': {
                            'attachments': [
                                {
                                    'contentType': 'application/vnd.microsoft.card.hero',
                                    'content': {
                                        'text': '顯示的文字',
                                        'buttons': [
                                            {
                                                'type': 'postBack',
                                                'title': 'YES',
                                                'value': 'YES',
                                                'dialog_id': 0
                                            },
                                            {
                                                'type': 'postBack',
                                                'title': 'NO',
                                                'value': 'NO',
                                                'dialog_id': 0
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    };
                } else if ($(this).val() == 'condition') {
                    TargetDialog = { 'dialog_id': TargetDialog.dialog_id, 'type': 'condition', 'field': '', 'prompt': '' };
                    $('#TxtField').prop('disabled', true);
                } else if ($(this).val() == 'operate') {
                    $('#DivNext').removeClass('hidden');
                    TargetDialog = { 'dialog_id': TargetDialog.dialog_id, 'type': 'operate', 'field': '', 'prompt': '', next: 0, operate: '' };
                } else if ($(this).val() == 'webapi') {
                    $('#DivNext').removeClass('hidden');
                    TargetDialog = { 'dialog_id': TargetDialog.dialog_id, 'type': 'webapi', 'webapi': { 'method': 'get', 'headers': [], 'body': '' }, 'field': '', 'prompt': '', next: 0 };
                    $('#TxtField').prop('disabled', true);
                } else if ($(this).val() == 'qna_maker') {
                    $('#DivNext').removeClass('hidden');
                    TargetDialog = { 'dialog_id': TargetDialog.dialog_id, 'type': 'qna_maker', 'field': '', 'qna_code': '', 'qna_key': '' };
                }

                if (TargetDialog.type == 'condition') {
                    $('#DivDialog').addClass('hidden');
                    $('#DivCondition').removeClass('hidden');
                    $('#DivOperate').addClass('hidden');
                    $('#DivWebAPI').addClass('hidden');
                    $('#DivQnAMaker').addClass('hidden');
                } else if (TargetDialog.type == 'webapi') {
                    $('#DivDialog').addClass('hidden');
                    $('#DivCondition').addClass('hidden');
                    $('#DivOperate').addClass('hidden');
                    $('#DivWebAPI').removeClass('hidden');
                    $('#DivQnAMaker').addClass('hidden');
                } else if (TargetDialog.type == 'operate') {
                    $('#DivDialog').addClass('hidden');
                    $('#DivCondition').addClass('hidden');
                    $('#DivOperate').removeClass('hidden');
                    $('#DivWebAPI').addClass('hidden');
                    $('#DivQnAMaker').addClass('hidden');
                } else if (TargetDialog.type == 'qna_maker') {
                    $('#DivDialog').addClass('hidden');
                    $('#DivCondition').addClass('hidden');
                    $('#DivOperate').addClass('hidden');
                    $('#DivWebAPI').addClass('hidden');
                    $('#DivQnAMaker').removeClass('hidden');
                } else {
                    $('#DivDialog').removeClass('hidden');
                    $('#DivCondition').addClass('hidden');
                    $('#DivOperate').addClass('hidden');
                    $('#DivWebAPI').addClass('hidden');
                    $('#DivQnAMaker').addClass('hidden');
                }
                TempDialog = TargetDialog;
                $('#TxtDialog').html(CreateContent(TargetDialog, 'Edit'));
                $('#TxtField').val('');
                $('#TxtDescription').val('');
            });

            $('#SelLocale').change(function () {
                Locale = $(this).val();
                Refresh();
            });

            $('#BtnAdd').click(function () {
                $('#DialogModal')
                    .attr({
                        Mode: 'ADD'
                    })
                    .modal();
            });

            $('#BtnParams').click(function () {
                $('#TableHeaders tbody').empty();
                if (TargetDialog.webapi.headers == undefined) {
                    TargetDialog.webapi.headers = [];
                }
                for (var idx = 0; idx < TargetDialog.webapi.headers.length; idx++) {
                    $('#TableHeaders')
                        .append(
                            $(document.createElement('tr'))
                                .append(
                                    $(document.createElement('td'))
                                        .append(
                                            $(document.createElement('button'))
                                                .attr('title', '刪除')
                                                .addClass('btn btn-warning btn-circle btn-xs')
                                                .append(
                                                    $(document.createElement('i'))
                                                        .addClass('fa fa-times')
                                                )
                                                .click(function () {
                                                    $(this).parent().parent().remove();
                                                })
                                        )
                                )
                                .append(
                                    $(document.createElement('td'))
                                        .append(
                                            $(document.createElement('input'))
                                                .attr('name', 'Name')
                                                .val(TargetDialog.webapi.headers[idx].name)
                                                .css({
                                                    'word-break': 'break-all',
                                                    'border': 0
                                                })
                                        )
                                ).append(
                                    $(document.createElement('td'))
                                        .append(
                                            $(document.createElement('input'))
                                                .attr('name', 'Value')
                                                .val(TargetDialog.webapi.headers[idx].value)
                                                .css({
                                                    'word-break': 'break-all',
                                                    'border': 0
                                                })
                                        )
                                )
                        )
                }
                $('#PostModal').find('textarea[name="Body"]').val(TargetDialog.webapi.body);
                $('#PostModal')
                    .attr({
                        Mode: 'ADD'
                    })
                    .modal();
            });

            $('#BtnVariable').click(function () {
                RefreshVarialbeTable();
                $('#VariableModal')
                    .modal();
            });

            $('#BtnMessage').click(function () {
                RefreshLocaleTable(Locale);
                $('#MessageModal')
                    .modal();
            });

            $('#BtnView').click(function () {
                window.open('flowchart/' + FlowID);
            });

            $('#BtnAddVariable').click(function () {
                AddVariable();
            });

            $('#BtnAddMessage').click(function () {
                AddMessage();
            });

            $('#BtnAddHeader').click(function () {
                AddHeader();
            });

            $('#BtnSavePost').click(function () {
                var post = {};
                post.headers = [];
                var headers = $('#TableHeaders').find('tr');
                for (var idx = 1; idx < headers.length; idx++) {
                    var header = {};
                    header.name = $(headers[idx]).find('input[name="Name"]').val();
                    header.value = $(headers[idx]).find('input[name="Value"]').val();
                    if (header.name != undefined && header.name != '') {
                        if (header.value == undefined) {
                            header.value = '';
                        }
                        post.headers.push(header);
                    }
                }
                post.body = $('#PostModal').find('[name="Body"]').val();
                TempDialog.webapi.headers = post.headers;
                TempDialog.webapi.body = post.body;
                $('#PostModal').modal('toggle');
                return false;
            });

            $('#BtnSaveVariable').click(function () {
                var TempVariables = new $.Hashtable();
                for (var index = 1; index < $('#TableVariables tr').length; index++) {
                    var $Name = $('#TableVariables tr').eq(index).find('[name="Name"]');
                    if ($Name.is('input')) {
                        if ($Name.val() == '') {
                            ShowMessage('名稱不能為空');
                            return;
                        }
                    }
                    if ($('#TableVariables tr').eq(index).find('input[name="Description"]').val() == '') {
                        ShowMessage('描述不能為空');
                        return;
                    }
                    var VariableName = $('#TableVariables tr').eq(index).attr('VariableName');
                    if (VariableName == undefined) {    // 新增的變數
                        VariableName = $Name.val();
                    }
                    if (TempVariables.containsKey(VariableName)) {
                        ShowMessage('變數名稱不能重複');
                        return;
                    }
                    var Content = $('#TableVariables tr').eq(index).find('[name="Content"]').val();
                    var Description = $('#TableVariables tr').eq(index).find('[name="Description"]').val();
                    TempVariables.add(VariableName, {
                        name: VariableName,
                        content: Content,
                        description: Description
                    });
                }
                var _Variables = [];
                for (var index = 0; index < TempVariables.getKeys().length; index++) {
                    _Variables.push(TempVariables.get(TempVariables.getKeys()[index]));
                }
                Loading();
                $.ajax({
                    url: '../../variables/' + FlowID,
                    type: 'PUT',
                    data: { variables: _Variables },
                    success: function (ret) {
                        Loaded();
                        $('#VariableModal').modal('toggle');
                        RefreshVariable();
                    }
                });
            });

            $('#BtnSaveMessage').click(function () {
                var TempMessage = {};
                for (var index = 1; index < $('#TableMessages tr').length; index++) {
                    var $MessageID = $('#TableMessages tr').eq(index).find('[name="MessageID"]');
                    if ($MessageID.is('input')) {
                        if ($MessageID.val() == '') {
                            ShowMessage('訊息編號不能為空');
                            return;
                        }
                    }
                    var MessageID = $('#TableMessages tr').eq(index).attr('MessageID');
                    if (MessageID == undefined) {    // 新增的變數
                        MessageID = $MessageID.val();
                    }
                    if (TempMessage[MessageID]) {
                        ShowMessage('訊息編號不能重複');
                        return;
                    }
                    var Content = $('#TableMessages tr').eq(index).find('[name="Content"]').val();
                    TempMessage[MessageID] = Content;
                }
                Loading();
                $.ajax({
                    url: '../../locale/' + Locale + '/' + FlowID,
                    type: 'PUT',
                    data: { message: TempMessage },
                    success: function (ret) {
                        Loaded();
                        $('#MessageModal').modal('toggle');
                        RefreshMessage();
                    }
                });
            });
            //新增對話框時所使用的function
            $('#DialogForm').bootstrapValidator({
                feedbackIcons: {
                },
                fields: {
                    DialogID: {
                        validators: {
                            notEmpty: {
                                message: '不得為空值'
                            }
                        }
                    }
                },
                fields: {
                    Description: {
                        validators: {
                            notEmpty: {
                                message: '不得為空值'
                            }
                        }
                    }
                }
            }).on('error.form.bv', function (e, data) {
            }).on('success.form.bv', function (e, data) {
                Loading();
                if ($('#DialogModal').attr('Mode') == 'EDIT') {
                    if ($('#TxtExistedDialogID').val() != $('#TxtRecordDialogID').val()) {
                        var changeDialog_id = parseInt($('#TxtExistedDialogID').val());
                        var orginalDialog_id = parseInt($('#TxtRecordDialogID').val());
                        if (orginalDialog_id < changeDialog_id) {
                            Dialogs[orginalDialog_id].dialog_id = changeDialog_id;
                            for (var index = orginalDialog_id + 1; index <= changeDialog_id; index++) {
                                Dialogs[index].dialog_id = index - 1;
                            }
                        } else if (orginalDialog_id > changeDialog_id) {
                            Dialogs[orginalDialog_id].dialog_id = changeDialog_id;
                            for (var index = orginalDialog_id - 1; index >= changeDialog_id; index--) {
                                Dialogs[index].dialog_id = index + 1;
                            }
                        }
                        for (var i = 0; i < Dialogs.length; i++) {
                            for (var j = 0; j < Dialogs.length; j++) {
                                if (Dialogs[i].next == Dialogs[j].dialog_uuid) {
                                    Dialogs[i].next_id = Dialogs[j].dialog_id;
                                }
                            }
                        }
                        $.ajax({
                            url: '../../dialog/' + 'editAll' + '/' + FlowID,
                            type: 'PUT',
                            data: { dialog: Dialogs },
                            success: function (ret) {
                                updateEdit();
                            }
                        });
                    } else {
                        updateEdit();
                    }
                } else {
                    TempDialog.dialog_uuid = $('#TxtUniqueDialogID').val();
                    TempDialog.dialog_id = $('#TxtDialogID').val();
                    TempDialog.field = $('#TxtField').val();
                    TempDialog.description = $('#TxtDescription').val();
                    if (TargetDialog.type != 'condition' && TargetDialog.type != 'confirm' && TargetDialog.type != 'choice') {
                        TempDialog.next = $('#TxtNext').val();
                        for (var i = 0; i < Dialogs.length; i++) {
                            if (TempDialog.next == Dialogs[i].dialog_uuid) {
                                TempDialog.next_id = Dialogs[i].dialog_id;
                                break;
                            }
                        }
                    } else {
                        TempDialog.next = TempDialog.dialog_uuid;
                        TempDialog.next_id = 0;
                    }
                    for (var index = 0; index < Dialogs.length; index++) {
                        if (TempDialog.next == Dialogs[index].dialog_uuid) TempDialog.next_id = Dialogs[index].dialog_id;
                    }
                    if (TempDialog.next == -3) {
                        TempDialog.skill = $('#TxtSkill').val();
                    }
                    if (TempDialog.type == 'condition') {
                        var condition = {};
                        condition.type = $('#DivCondition').find('[name="Type"]').val();
                        condition.field = $('#DivCondition').find('[name="Field"]').val();
                        condition.target_type = $('#DivCondition').find('[name="TargetType"]').val();
                        if (condition.target_type == 'Const') {
                            condition.target_field = $('#DivCondition').find('input[name="TargetField"]').val();
                        } else {
                            condition.target_field = $('#DivCondition').find('select[name="TargetField"]').val();
                        }
                        condition.success_dialog_id = $('#DivCondition').find('[name="SuccessDialog"]').val();
                        condition.fail_dialog_id = $('#DivCondition').find('[name="FailDialog"]').val();
                        TempDialog.condition = condition;
                    }
                    if (TempDialog.type == 'operate') {
                        TempDialog.operate = $('#DivOperate').find('[name="Operate"]').val();
                    }
                    if (TempDialog.type == 'webapi') {
                        var webapi = {};
                        webapi.protocol = $('#DivWebAPI').find('[name="Protocol"]').val();
                        webapi.host = $('#DivWebAPI').find('[name="Host"]').val();
                        webapi.port = $('#DivWebAPI').find('[name="Port"]').val();
                        webapi.path = $('#DivWebAPI').find('[name="Path"]').val();
                        webapi.method = $('#DivWebAPI').find('[name="Method"]').val();
                        webapi.headers = TempDialog.webapi.headers;
                        webapi.body = TempDialog.webapi.body;
                        TempDialog.webapi = webapi;
                    }
                    if (TempDialog.type == 'qna_maker') {
                        var qna_maker = {};
                        qna_maker.code = $('#DivQnAMaker').find('[name="Code"]').val();
                        qna_maker.key = $('#DivQnAMaker').find('[name="Key"]').val();
                        qna_maker.problem = $('#DivQnAMaker').find('[name="Problem"]').val();
                        TempDialog.qna_maker = qna_maker;
                    }
                    $.post('../../dialog/' + FlowID,
                        { dialog: TempDialog },
                        function (ret, status) {
                            Loaded();
                            if (status == 'success') {
                                $('#DialogModal').modal('toggle');
                                Refresh();
                                RefreshVariable();
                                RefreshLocaleTable();
                            } else {
                                ShowMessage(ret);
                            }
                        }
                    );
                }
                return false;   // 防止 Submit 造成畫面 Reload
            });

            $('#DialogModal').on('shown.bs.modal', function () {
                $('[id^="Template"').addClass('hidden');
                $('#TxtNext option[value="-2"]').remove();
                $('#TxtNext option[value="-3"]').remove();
                if ($(this).attr('Mode') == 'EDIT') {
                    $('#TxtNext').prepend('<option value="-2" class="text-primary">#系統 結束</option>');
                    $('#TxtNext').prepend('<option value="-3" class="text-primary">#系統 客服</option>');
                    $('#ModalTitle').text('對話框修改');
                    $('#TxtDialogID').prop('disabled', false);
                    $('#TxtDialogID').val($(this).attr('DialogID'));
                    $('#TxtDialogID').addClass('hidden');
                    $('#TxtExistedDialogID').removeClass('hidden');
                    Dialog_length = $(this).attr('Dialog_length');
                    $('#TxtExistedDialogID').empty();
                    for (var index = 0; index < Dialog_length; index++) {
                        $('#TxtExistedDialogID').append('<option value=' + index + '>' + index + '</option>');
                    }
                    $('#TxtExistedDialogID').val($(this).attr('DialogID'));
                    $('#TxtRecordDialogID').val($(this).attr('DialogID'));
                    TargetDialog = JSON.parse($(this).attr('Dialog'));
                    TempDialog = TargetDialog;
                    $('#TxtDialog').html(CreateContent(TargetDialog, 'Edit'));
                    $('#TxtField').val($(this).attr('Field'));
                    $('#TxtNext').val($(this).attr('Next'));
                    $('#DivNext').addClass('hidden');
                    $('#TxtSkill').val($(this).attr('Skill'));
                    $('#DivTransfer').addClass('hidden');
                    if (TargetDialog.type == 'text') {
                        $('#DivNext').removeClass('hidden');
                        $('#TxtField').prop('disabled', true);
                        $('#TxtNext').val(TargetDialog.next);
                    } else if (TargetDialog.type == 'input') {
                        $('#DivNext').removeClass('hidden');
                        $('#TxtField').prop('disabled', false);
                        $('#TxtNext').val(TargetDialog.next);
                    } else if (TargetDialog.type == 'card') {
                        $('#DivNext').removeClass('hidden');
                        $('#TxtField').prop('disabled', true);
                        $('#TxtNext').val(TargetDialog.next);
                    } else if (TargetDialog.type == 'webapi') {
                        $('#DivNext').removeClass('hidden');
                        $('#TxtField').prop('disabled', false);
                        $('#TxtNext').val(TargetDialog.next);
                    } else if (TargetDialog.type == 'operate') {
                        $('#DivNext').removeClass('hidden');
                        $('#TxtField').prop('disabled', false);
                        $('#TxtNext').val(TargetDialog.next);
                    } else if (TargetDialog.type == 'qna_maker') {
                        $('#DivNext').removeClass('hidden');
                        $('#TxtField').prop('disabled', false);
                        $('#TxtNext').val(TargetDialog.next);
                    } else {
                        $('#TxtField').prop('disabled', false);
                    }
                    if (TargetDialog.type == 'condition') {
                        $('#DivDialog').addClass('hidden');
                        $('#DivCondition').removeClass('hidden');
                        $('#DivOperate').addClass('hidden');
                        $('#DivWebAPI').addClass('hidden');
                        $('#DivQnAMaker').addClass('hidden');
                        $('#DivCondition').find('select[name="Field"]').val(TargetDialog.condition.field);
                        $('#DivCondition').find('select[name="Type"]').val(TargetDialog.condition.type);
                        $('#DivCondition').find('input[name="TargetType"]').val(TargetDialog.condition.target_type);
                        if (TargetDialog.condition.target_type == '0') {
                            $('#DivCondition').find('input[name="TargetField"]').val(TargetDialog.condition.target_field);
                        } else {
                            $('#DivCondition').find('select[name="TargetField"]').val(TargetDialog.condition.target_field);
                        }
                        $('#DivCondition').find('select[name="SuccessDialog"]').val(TargetDialog.condition.success_dialog_id);
                        $('#DivCondition').find('select[name="FailDialog"]').val(TargetDialog.condition.fail_dialog_id);
                    } else if (TargetDialog.type == 'operate') {
                        $('#DivDialog').addClass('hidden');
                        $('#DivCondition').addClass('hidden');
                        $('#DivOperate').removeClass('hidden');
                        $('#DivWebAPI').addClass('hidden');
                        $('#DivQnAMaker').addClass('hidden');
                        $('#DivOperate').find('[name="Operate"]').val(TargetDialog.operate);
                    } else if (TargetDialog.type == 'webapi') {
                        $('#DivDialog').addClass('hidden');
                        $('#DivCondition').addClass('hidden');
                        $('#DivOperate').addClass('hidden');
                        $('#DivWebAPI').removeClass('hidden');
                        $('#DivQnAMaker').addClass('hidden');
                        $('#DivWebAPI').find('select[name="Protocol"]').val(TargetDialog.webapi.protocol);
                        $('#DivWebAPI').find('input[name="Host"]').val(TargetDialog.webapi.host);
                        $('#DivWebAPI').find('input[name="Port"]').val(TargetDialog.webapi.port);
                        $('#DivWebAPI').find('input[name="Path"]').val(TargetDialog.webapi.path);
                        $('#DivWebAPI').find('select[name="Method"]').val(TargetDialog.webapi.method);
                        $('#BtnParams').addClass('hidden');
                        if (TargetDialog.webapi.method != 'get') {
                            $('#BtnParams').removeClass('hidden');
                        }
                    } else if (TargetDialog.type == 'qna_maker') {
                        $('#DivDialog').addClass('hidden');
                        $('#DivCondition').addClass('hidden');
                        $('#DivOperate').addClass('hidden');
                        $('#DivWebAPI').addClass('hidden');
                        $('#DivQnAMaker').removeClass('hidden');
                        $('#DivQnAMaker').find('input[name="Code"]').val(TargetDialog.qna_maker.code);
                        $('#DivQnAMaker').find('input[name="Key"]').val(TargetDialog.qna_maker.key);
                        $('#DivQnAMaker').find('input[name="Problem"]').val(TargetDialog.qna_maker.problem);
                    } else {
                        $('#DivDialog').removeClass('hidden');
                        $('#DivCondition').addClass('hidden');
                        $('#DivOperate').addClass('hidden');
                        $('#DivWebAPI').addClass('hidden');
                        $('#DivQnAMaker').addClass('hidden');
                    }
                    if ($('#TxtNext').val() == '-3' && $(this).attr('Next') != 0) {
                        $('#DivTransfer').removeClass('hidden');
                    }
                    $('#TxtDescription').val($(this).attr('Description'));
                    $('#TxtType').val($(this).attr('Type'));
                } else {
                    $('#ModalTitle').text('對話框新增');
                    var uuid = guid();
                    $('#TxtUniqueDialogID').val(uuid);
                    $('#TxtDialogID').removeClass('hidden');
                    $('#TxtDialogID').prop('disabled', true);
                    $('#TxtExistedDialogID').addClass('hidden');
                    TargetDialog = { dialog_id: Dialogs.length, type: 'text', prompt: '顯示的文字' };
                    TempDialog = TargetDialog;
                    $('#TxtDialog').html(CreateContent(TargetDialog, 'Edit'));
                    $('#TxtDialogID').val(Dialogs.length);
                    $('#DivDialog').removeClass('hidden');
                    $('#DivCondition').addClass('hidden');
                    $('#DivOperate').addClass('hidden');
                    $('#DivWebAPI').addClass('hidden');
                    $('#DivQnAMaker').addClass('hidden');
                    $('#TxtField').val('');
                    $('#TxtField').prop('disabled', true);
                    $('#TxtDescription').val('');
                    $('#TxtType').val('text');
                    $('#TxtNext').find('select').prop('selectedIndex', 0);
                    $('#TxtSkill').find('select').prop('selectedIndex', 0);
                    $('#DivNext').removeClass('hidden');
                    $('#DivTransfer').addClass('hidden');
                    $('#TxtNext').prepend('<option value="-2" class="text-primary">#系統 結束</option>');
                    $('#TxtNext').prepend('<option value="-3" class="text-primary">#系統 客服</option>');
                    var TxtNextIndex = $("#TxtNext").children("option").length;
                    if (TxtNextIndex < 3) {
                        $("#TxtNext")[0].selectedIndex = 0;
                    } else {
                        $("#TxtNext")[0].selectedIndex = 2;
                    }
                    // Condition
                    $('#DivCondition').find('select').prop('selectedIndex', 0);
                    $('#DivCondition').find('input[name="TargetField"]').removeClass('hidden');
                    $('#DivCondition').find('select[name="TargetField"]').addClass('hidden');
                    $('#DivWebAPI').find('select[name="Protocol"]').val('http');
                    $('#DivWebAPI').find('input[name="Host"]').val('');
                    $('#DivWebAPI').find('input[name="Port"]').val('');
                    $('#DivWebAPI').find('input[name="Path"]').val('');
                    $('#DivWebAPI').find('input[name="Method"]').val('get');
                    $('#DivWebAPI').find('input[name="Method"]').removeClass('hidden');
                    $('#TableHeaders tbody').empty();
                    for (var idx = 0; idx < TargetDialog.webapi.headers.length; idx++) {
                        $('#TableHeaders')
                            .append(
                                $(document.createElement('tr'))
                                    .append(
                                        $(document.createElement('td'))
                                            .append(
                                                $(document.createElement('button'))
                                                    .attr('title', '刪除')
                                                    .addClass('btn btn-warning btn-circle btn-xs')
                                                    .append(
                                                        $(document.createElement('i'))
                                                            .addClass('fa fa-times')
                                                    )
                                                    .click(function () {
                                                        $(this).parent().parent().remove();
                                                    })
                                            )
                                    )
                                    .append(
                                        $(document.createElement('td'))
                                            .append(
                                                $(document.createElement('input'))
                                                    .attr('name', 'Name')
                                                    .val('')
                                                    .css({
                                                        'word-break': 'break-all',
                                                        'border': 0
                                                    })
                                            )
                                    ).append(
                                        $(document.createElement('td'))
                                            .append(
                                                $(document.createElement('input'))
                                                    .attr('name', 'Value')
                                                    .val('')
                                                    .css({
                                                        'word-break': 'break-all',
                                                        'border': 0
                                                    })
                                            )
                                    )
                            )
                    }
                    $('#DivWebAPI').find('textarea[name="Body"]').val('');
                    $('#DivQnaMaker').find('input[name="Code"]').val('');
                    $('#DivQnaMaker').find('input[name="Key"]').val('');
                }
                $('#DialogForm').data('bootstrapValidator').resetForm();
            });

            $('.auto_complete')
                .bind("keydown", function (event) {
                    if (event.keyCode === $.ui.keyCode.TAB &&
                        $(this).data("ui-autocomplete").menu.active) {
                        event.preventDefault();
                    }
                })
                .autocomplete({
                    minLength: 0,
                    source: function (request, response) {
                        var Variable = [];
                        var Locale_for_AC = [];
                        var isParameter = split(request.term, /%\s*/).length % 2;
                        var isMessage = split(request.term, /{\s*/).length;
                        if (auto_message == -1) auto_message = isMessage;
                        var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                        if (isParameter == 0 || isMessage != auto_message) {
                            console.log("sign");
                            if (isParameter == 0) {
                                for (var index = 0; index < Variables.getKeys().length; index++) {
                                    var data = {};
                                    data.label = Variables.get(Variables.getKeys()[index]).name;
                                    Variable.push(data);
                                }
                                response($.ui.autocomplete.filter(Variable, extractLast(request.term, /%\s*/)));
                            }
                            if (isMessage != auto_message) {
                                if (isMessage > auto_message) {
                                    var Locale_AC = Locales[Locale];
                                    for (var Property in Locale_AC) {
                                        if (Property == '_used') continue;
                                        var Content = Property;
                                        var data = {};
                                        data.label = Content;
                                        Locale_for_AC.push(data);
                                    }
                                    console.log(Locale_for_AC);
                                    response($.ui.autocomplete.filter(Locale_for_AC, extractLast(request.term, /{\s*/)));
                                }
                                else {
                                    auto_message = isMessage;
                                    response(false);
                                }
                            }
                        }
                        else {
                            response(false);
                        }
                    },
                    focus: function () {
                        // 防止在获得焦点时插入值
                        return false;
                    },
                    select: function (event, ui) {
                        var isParameter = split(this.value, /%\s*/).length % 2;
                        var isMessage = split(this.value, /{\s*/).length;
                        console.log('sign in select');
                        if (isParameter == 0) {
                            var terms = split(this.value, /%\s*/);
                            // 移除当前输入
                            terms.pop();
                            // 添加被选项
                            terms.push(ui.item.value);
                            // 添加占位符，在结尾添加逗号+空格
                            terms.push("");
                            this.value = terms.join("%");
                        }
                        if (isMessage != auto_message) {
                            if (isMessage > auto_message) {
                                auto_message = isMessage;
                                var terms = split(this.value, /{\s*/);
                                // 移除当前输入
                                terms.pop();
                                // 添加被选项
                                terms.push(ui.item.value + '}');
                                console.log(terms);
                                this.value = terms.join("{");
                            }
                        }
                        return false;
                    }
                });
        });

        var TargetDialog = {};
        var TempDialog = {};
        var TargetDialogItem;

        var normalize = function (term) {
            var ret = "";
            for (var i = 0; i < term.length; i++) {
                ret += term.charAt(i);
            }
            return ret;
        };

        function updateEdit() {
            for (var index = 0; index < Dialogs.length; index++) {
                var Dialog = Dialogs[index];
                if (Dialog.dialog_id == $('#TxtExistedDialogID').val()) {
                    TempDialog.dialog_uuid = Dialog.dialog_uuid;
                    TempDialog.dialog_id = $('#TxtExistedDialogID').val();
                    TempDialog.field = $('#TxtField').val();
                    TempDialog.description = $('#TxtDescription').val();
                    if (Dialog.type != 'condition' && Dialog.type != 'confirm' && Dialog.type != 'choice') {
                        TempDialog.next = $('#TxtNext').val();
                        for (var i = 0; i < Dialogs.length; i++) {
                            if (TempDialog.next == Dialogs[i].dialog_uuid) {
                                TempDialog.next_id = Dialogs[i].dialog_id;
                                break;
                            }
                        }
                    } else {
                        TempDialog.next = 0;
                        TempDialog.next_id = 0;
                    }
                    if (TempDialog.next == -3) {
                        TempDialog.skill = $('#TxtSkill').val();
                    }
                    if (TempDialog.type == 'condition') {
                        var condition = {};
                        condition.type = $('#DivCondition').find('[name="Type"]').val();
                        condition.field = $('#DivCondition').find('[name="Field"]').val();
                        condition.target_type = $('#DivCondition').find('[name="TargetType"]').val();
                        if (condition.target_type == 'Const') {
                            condition.target_type = '0';
                            condition.target_field = $('#DivCondition').find('input[name="TargetField"]').val();
                        } else {
                            condition.target_type = '1';
                            condition.target_field = $('#DivCondition').find('select[name="TargetField"]').val();
                        }
                        condition.success_dialog_id = $('#DivCondition').find('[name="SuccessDialog"]').val();
                        condition.fail_dialog_id = $('#DivCondition').find('[name="FailDialog"]').val();
                        TempDialog.condition = condition;
                    }
                    if (TempDialog.type == 'operate') {
                        TempDialog.operate = $('#DivOperate').find('[name="Operate"]').val();
                    }
                    if (TempDialog.type == 'webapi') {
                        var webapi = {};
                        webapi.protocol = $('#DivWebAPI').find('[name="Protocol"]').val();
                        webapi.host = $('#DivWebAPI').find('[name="Host"]').val();
                        webapi.port = $('#DivWebAPI').find('[name="Port"]').val();
                        webapi.path = $('#DivWebAPI').find('[name="Path"]').val();
                        webapi.method = $('#DivWebAPI').find('[name="Method"]').val();
                        webapi.headers = TempDialog.webapi.headers;
                        webapi.body = TempDialog.webapi.body;
                        TempDialog.webapi = webapi;
                    }
                    if (TempDialog.type == 'qna_maker') {
                        var qna_maker = {};
                        qna_maker.code = $('#DivQnAMaker').find('[name="Code"]').val();
                        qna_maker.key = $('#DivQnAMaker').find('[name="Key"]').val();
                        qna_maker.problem = $('#DivQnAMaker').find('[name="Problem"]').val();
                        TempDialog.qna_maker = qna_maker;
                    }
                    Dialogs[index] = TempDialog;
                    $.ajax({
                        url: '../../dialog/' + Dialogs[index].dialog_id + '/' + FlowID,
                        type: 'PUT',
                        data: { dialog: Dialogs[index] },
                        success: function (ret) {
                            Loaded();
                            $('#DialogModal').modal('toggle');
                            Refresh();
                            RefreshVariable();
                            RefreshLocaleTable();
                        }
                    });
                    break;
                }
            }
        }

        function Refresh() {
            try {
                $MainTable.fnDestroy();
            } catch (e) {
            }
            var $Table = $('#TableDialogs tbody');
            $Table.empty();
            Locales = [];
            Dialogs = [];
            $.getJSON('../../locales/' + FlowID, function (data) {
                Locales = data;
                $.getJSON('../../dialogs/' + FlowID, function (data) {
                    Dialogs = data;
                    $('#TemplateButton').find('[name="DialogID"]').empty();
                    $('#DivCondition').find('[name="SuccessDialog"]').empty();
                    $('#DivCondition').find('[name="FailDialog"]').empty();
                    $('#TemplateButton').find('[name="DialogID"]').prepend('<option value="-2" class="text-primary">#系統 結束</option>');
                    $('#TemplateButton').find('[name="DialogID"]').prepend('<option value="-3" class="text-primary">#系統 客服</option>');
                    $('#DivCondition').find('[name="SuccessDialog"]').prepend('<option value="-2" class="text-primary">#系統 結束</option>');
                    $('#DivCondition').find('[name="SuccessDialog"]').prepend('<option value="-3" class="text-primary">#系統 客服</option>');
                    $('#DivCondition').find('[name="FailDialog"]').prepend('<option value="-2" class="text-primary">#系統 結束</option>');
                    $('#DivCondition').find('[name="FailDialog"]').prepend('<option value="-3" class="text-primary">#系統 客服</option>');
                    $('#TxtNext').empty();
                    for (var index = 0; index < Dialogs.length; index++) {
                        $('#TemplateButton').find('[name="DialogID"]').append('<option value="' + Dialogs[index].dialog_uuid + '">#' + Dialogs[index].dialog_id + ' ' + Dialogs[index].description + '</option>');
                        $('#DivCondition').find('[name="SuccessDialog"]').append('<option value="' + Dialogs[index].dialog_uuid + '">#' + Dialogs[index].dialog_id + ' ' + Dialogs[index].description + '</option>');
                        $('#DivCondition').find('[name="FailDialog"]').append('<option value="' + Dialogs[index].dialog_uuid + '">#' + Dialogs[index].dialog_id + ' ' + Dialogs[index].description + '</option>');
                        $('#TxtNext').append('<option value="' + Dialogs[index].dialog_uuid + '">#' + Dialogs[index].dialog_id + ' ' + Dialogs[index].description + '</option>');
                        var Type;
                        if (Dialogs[index].type == 'text') {
                            Type = '文字';
                        } else if (Dialogs[index].type == 'card') {
                            Type = '圖文';
                        } else if (Dialogs[index].type == 'choice') {
                            Type = '選單';
                        } else if (Dialogs[index].type == 'confirm') {
                            Type = '確認視窗';
                        } else if (Dialogs[index].type == 'input') {
                            Type = '輸入';
                        } else if (Dialogs[index].type == 'condition') {
                            Type = '判斷式';
                        } else if (Dialogs[index].type == 'operate') {
                            Type = '運算式';
                        } else if (Dialogs[index].type == 'webapi') {
                            Type = 'Web API';
                        } else if (Dialogs[index].type == 'qna_maker') {
                            Type = 'QnA';
                        }
                        $('#TableDialogs')
                            .append(
                                $(document.createElement('tr'))
                                    .append(
                                        $(document.createElement('td'))
                                            .append(
                                                $(document.createElement('button'))
                                                    .attr('title', '刪除')
                                                    .attr('DialogID', Dialogs[index].dialog_id)
                                                    .addClass('btn btn-warning btn-circle')
                                                    .addClass(Dialogs[index].used == true ? 'hidden' : '')
                                                    .append(
                                                        $(document.createElement('i'))
                                                            .addClass('fa fa-times')
                                                    )
                                                    .click(function () {
                                                        DialogID_Delete = $(this).attr('DialogID');
                                                        bootbox.dialog({
                                                            message: '確定要刪除此項目？',
                                                            title: '',
                                                            buttons: {
                                                                Cancel: {
                                                                    label: '取消',
                                                                    className: 'btn-default'
                                                                },
                                                                OK: {
                                                                    label: '確定刪除',
                                                                    className: 'btn-danger',
                                                                    callback: function () {
                                                                        for (var index = 0; index < Dialogs.length; index++) {
                                                                            var Dialog = Dialogs[index];
                                                                            if (Dialog.dialog_id == DialogID_Delete) {
                                                                                Dialogs.splice(index, 1);
                                                                                DeleteMode = true;
                                                                                $.ajax({
                                                                                    url: '../../dialog/' + Dialog.dialog_id + '/' + FlowID,
                                                                                    type: 'DELETE',
                                                                                    success: function (data) {
                                                                                        Loaded();
                                                                                        Refresh();
                                                                                    }
                                                                                });
                                                                                break;
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        });
                                                    })
                                            )
                                    )
                                    .append(
                                        $(document.createElement('td'))
                                            .append(
                                                $(document.createElement('button'))
                                                    .attr('title', '編輯')
                                                    .addClass('btn btn-primary btn-circle')
                                                    .attr({
                                                        Dialog_uuid: Dialogs[index].dialog_uuid,
                                                        Dialog_length: Dialogs.length,
                                                        DialogID: Dialogs[index].dialog_id,
                                                        Dialog: JSON.stringify(Dialogs[index], null, 4),
                                                        Description: Dialogs[index].description,
                                                        Type: Dialogs[index].type,
                                                        Field: (Dialogs[index].field == undefined || Dialogs[index].field == '') ? '' : Dialogs[index].field,
                                                        Next: Dialogs[index].next,
                                                        Skill: Dialogs[index].skill
                                                    })
                                                    .append(
                                                        $(document.createElement('i'))
                                                            .addClass('fa fa-pencil-square-o')
                                                    )
                                                    .click(function () {
                                                        $('#DialogModal')
                                                            .attr({
                                                                Dialog_uuid: $(this).attr('Dialog_uuid'),
                                                                Dialog_length: $(this).attr('Dialog_length'),
                                                                DialogID: $(this).attr('DialogID'),
                                                                Type: $(this).attr('Type'),
                                                                Dialog: $(this).attr('Dialog'),
                                                                Field: $(this).attr('Field'),
                                                                Description: $(this).attr('Description'),
                                                                Next: $(this).attr('Next'),
                                                                Skill: $(this).attr('Skill'),
                                                                Mode: 'EDIT'
                                                            })
                                                            .modal();
                                                    })
                                            )
                                    )
                                    .append(
                                        $(document.createElement('td'))
                                            .append(
                                                $(document.createElement('div'))
                                                    .attr('id', Dialogs[index].dialog_id)
                                                    .css('word-break', 'break-all')
                                                    .html(Dialogs[index].dialog_id)
                                            )
                                    )
                                    .append(
                                        $(document.createElement('td'))
                                            .html(Type)
                                    )
                                    .append(
                                        $(document.createElement('td'))
                                            .append(
                                                $(document.createElement('div'))
                                                    .css('word-break', 'break-all')
                                                    .html(CreateContent(Dialogs[index]))
                                            )
                                    )
                                    .append(
                                        $(document.createElement('td'))
                                            .append((Dialogs[index].next_id == 0 && Dialogs[index].next != -2 && Dialogs[index].next != -3) ? '' : $(document.createElement('button'))
                                                .text(Dialogs[index].next == -2 ? '結束' : (Dialogs[index].next == -3 ? '客服' : (Dialogs[index].next_id == 0 ? '0' : Dialogs[index].next_id)))
                                                .addClass(Dialogs[index].next < 0 ? 'btn btn-success' : 'btn')
                                                .click(function () {
                                                    location.href = '#' + $(this).text();
                                                    $('#TableDialogs tr')
                                                        .eq(parseInt($(this).text()) + 1)
                                                        .animate({
                                                            opacity: 0.5
                                                        }, 200, function () {
                                                            $('#TableDialogs tr').animate({
                                                                opacity: 1
                                                            }, 200);
                                                        });
                                                })
                                            )
                                    )
                                    .append(
                                        $(document.createElement('td'))
                                            .html(Variables.containsKey(Dialogs[index].field) ? Variables.get(Dialogs[index].field).description : Dialogs[index].field)
                                            .addClass(Variables.containsKey(Dialogs[index].field) ? '' : 'text-danger')
                                    )
                                    .append(
                                        $(document.createElement('td')).html(Dialogs[index].description)
                                    )
                            );
                    }
                    $MainTable = $('#TableDialogs').dataTable({
                        'columnDefs': [
                            { 'searchable': false, 'sortable': false, 'targets': [0, 1, 2, 3, 4, 5, 6, 7] }
                        ],
                        'aaSorting': [[2, 'asc']],
                        'autoWidth': false,
                        'bPaginate': false,
                        'bFilter': false,
                        'sPaginationType': 'full_numbers',
                        'oLanguage': {
                            'sLengthMenu': '每頁顯示 _MENU_ 筆資料',
                            'sZeroRecords': '找不到資料',
                            'sInfo': '',
                            'sInfoEmpty': '',
                            'sInfoFiltered': ' (從 _MAX_ 資料的查詢結果)',
                            'sSearch': '快速搜尋：',
                            'oPaginate': {
                                'sFirst': '第一頁',
                                'sPrevious': '上一頁',
                                'sNext': '下一頁',
                                'sLast': '最末頁'
                            }
                        }
                    });
                });
            });
        }

        function RefreshVariable() {
            $('#TxtField').empty();
            $('#TxtField').append($('<option value="">無</option>'));
            $('#DivCondition').find('[name="Field"]').empty();
            $('#DivCondition').find('[name="TargetField"]').empty();
            $.getJSON('../../variables/' + FlowID, function (data) {
                Variables = new $.Hashtable();
                Variables.add('dialog_Id', { 'name': 'dialog_Id', 'content': '', 'description': '流程編號' });
                Variables.add('conversation_Id', { 'name': 'conversation_Id', 'content': '', 'description': '對話編號' });
                Variables.add('user_Id', { 'name': 'user_Id', 'content': '', 'description': '用戶編號' });
                $('#DivCondition').find('[name="Field"]').append($('<option value="' + 'dialog_Id' + '">' + '流程編號' + '</option>'));
                $('#DivCondition').find('select[name="TargetField"]').append($('<option value="' + 'dialog_Id' + '">' + '流程編號' + '</option>'));
                $('#DivCondition').find('[name="Field"]').append($('<option value="' + 'conversation_Id' + '">' + '對話編號' + '</option>'));
                $('#DivCondition').find('select[name="TargetField"]').append($('<option value="' + 'conversation_Id' + '">' + '對話編號' + '</option>'));
                $('#DivCondition').find('[name="Field"]').append($('<option value="' + 'user_Id' + '">' + '用戶編號' + '</option>'));
                $('#DivCondition').find('select[name="TargetField"]').append($('<option value="' + 'user_Id' + '">' + '用戶編號' + '</option>'));
                for (var index = 0; index < data.length; index++) {
                    Variables.add(data[index].name, data[index]);
                    $('#TxtField').append($('<option value="' + data[index].name + '">' + data[index].description + '</option>'));
                    $('#DivCondition').find('[name="Field"]').append($('<option value="' + data[index].name + '">' + data[index].description + '</option>'));
                    $('#DivCondition').find('select[name="TargetField"]').append($('<option value="' + data[index].name + '">' + data[index].description + '</option>'));
                }
            });
        }

        function RefreshMessage() {
            $.getJSON('../../locales/' + FlowID, function (data) {
                Locales = data;
            });
        }

        function GetStringBytes(Target) {
            var n = Target.length, s;
            var len = 0;
            for (var i = 0; i < n; i++) {
                s = Target.charCodeAt(i);
                while (s > 0) {
                    len++;
                    s = s >> 8;
                }
            }
            return len;
        }

        function RefreshLocaleTable(LocaleCode) {
            try {
                $MessageTable.fnDestroy();
            } catch (e) {
            }
            $('#TableMessages tbody').empty();
            var Locale = Locales[LocaleCode];
            for (var Property in Locale) {
                if (Property == '_used') continue;
                var Content = Locale[Property];
                var ContentLength = GetStringBytes(Content);
                $('#TableMessages')
                    .append(
                        $(document.createElement('tr'))
                            .attr('MessageID', Property)
                            .append(
                                $(document.createElement('td'))
                                    .append(
                                        $(document.createElement('button'))
                                            .attr('title', '刪除')
                                            .attr('MessageID', Property)
                                            .addClass('btn btn-warning btn-circle btn-xs')
                                            .addClass(Locale._used.indexOf(Property) >= 0 ? 'hidden' : '')
                                            .append(
                                                $(document.createElement('i'))
                                                    .addClass('fa fa-times')
                                            )
                                            .click(function () {
                                                $(this).parent().parent().remove();
                                            })
                                    )
                            )
                            .append(
                                $(document.createElement('td'))
                                    .append(
                                        $(document.createElement('div'))
                                            .append(
                                                $(document.createElement('div'))
                                                    .attr('id', Property)
                                                    .attr('name', 'MessageID')
                                                    .css({
                                                        'word-break': 'break-all',
                                                        'border': 0
                                                    })
                                                    .html(Property)
                                            )
                                    )
                            )
                            .append(
                                $(document.createElement('td'))
                                    .append(
                                        $(document.createElement('div'))
                                            .append($(document.createElement('textarea'))
                                                .attr('name', 'Content')
                                                .attr('cols', 46)
                                                .attr('rows', Math.ceil(ContentLength / 46))
                                                .css({
                                                    'word-break': 'break-all',
                                                    'border': 0,
                                                    'width': '100%',
                                                    'resize': 'none'
                                                })
                                                .val(Locale[Property])
                                            )
                                    )
                            )
                    );
            }
            $MessageTable = $('#TableMessages').dataTable({
                'columnDefs': [
                    { 'searchable': false, 'sortable': false, 'targets': [0, 1, 2] }
                ],
                'aaSorting': [[0, 'asc']],
                'autoWidth': false,
                'bPaginate': false,
                'bFilter': false,
                'sPaginationType': 'full_numbers',
                'oLanguage': {
                    'sLengthMenu': '每頁顯示 _MENU_ 筆資料',
                    'sZeroRecords': '找不到資料',
                    'sInfo': '',
                    'sInfoEmpty': '',
                    'sInfoFiltered': ' (從 _MAX_ 資料的查詢結果)',
                    'sSearch': '快速搜尋：',
                    'oPaginate': {
                        'sFirst': '第一頁',
                        'sPrevious': '上一頁',
                        'sNext': '下一頁',
                        'sLast': '最末頁'
                    }
                }
            });
        }

        function RefreshVarialbeTable() {
            try {
                $VariableTable.fnDestroy();
            } catch (e) {
            }
            $('#TableVariables tbody').empty();
            for (var index = 0; index < Variables.getKeys().length; index++) {
                var Variable = Variables.get(Variables.getKeys()[index]);
                if (Variable.name != 'dialog_Id' && Variable.name != 'user_Id' && Variable.name != 'conversation_Id') {
                    $('#TableVariables')
                        .append(
                            $(document.createElement('tr'))
                                .attr('VariableName', Variable.name)
                                .append(
                                    $(document.createElement('td'))
                                        .append(
                                            $(document.createElement('button'))
                                                .attr('title', '刪除')
                                                .attr('VariableName', Variable.name)
                                                .addClass('btn btn-warning btn-circle btn-xs')
                                                .addClass((Variable.system || Variable.used) ? 'hidden' : '')
                                                .append(
                                                    $(document.createElement('i'))
                                                        .addClass('fa fa-times')
                                                )
                                                .click(function () {
                                                    $(this).parent().parent().remove();
                                                })
                                        )
                                )
                                .append(
                                    $(document.createElement('td'))
                                        .append(
                                            $(document.createElement('div'))
                                                .append(
                                                    $(document.createElement('div'))
                                                        .attr('id', Variable.name)
                                                        .attr('name', 'Name')
                                                        .css({
                                                            'word-break': 'break-all',
                                                            'border': 0
                                                        })
                                                        .html(Variable.name)
                                                )
                                        )
                                )
                                .append(
                                    $(document.createElement('td'))
                                        .append(
                                            $(document.createElement('div'))
                                                .append($(document.createElement('input'))
                                                    .attr('name', 'Content')
                                                    .css({
                                                        'word-break': 'break-all',
                                                        'border': 0
                                                    })
                                                    .val(Variable.content)
                                                )
                                        )
                                )
                                .append(
                                    $(document.createElement('td'))
                                        .append(
                                            $(document.createElement('div'))
                                                .append($(document.createElement('input'))
                                                    .attr('name', 'Description')
                                                    .css({
                                                        'word-break': 'break-all',
                                                        'border': 0
                                                    })
                                                    .val(Variable.description)
                                                )
                                        )
                                )
                        );
                }
            }
            $VariableTable = $('#TableVariables').dataTable({
                'columnDefs': [
                    { 'searchable': false, 'sortable': false, 'targets': [0, 1, 2, 3] }
                ],
                'aaSorting': [[0, 'asc']],
                'autoWidth': false,
                'bPaginate': false,
                'bFilter': false,
                'sPaginationType': 'full_numbers',
                'oLanguage': {
                    'sLengthMenu': '每頁顯示 _MENU_ 筆資料',
                    'sZeroRecords': '找不到資料',
                    'sInfo': '',
                    'sInfoEmpty': '',
                    'sInfoFiltered': ' (從 _MAX_ 資料的查詢結果)',
                    'sSearch': '快速搜尋：',
                    'oPaginate': {
                        'sFirst': '第一頁',
                        'sPrevious': '上一頁',
                        'sNext': '下一頁',
                        'sLast': '最末頁'
                    }
                }
            });
        }

        function AddVariable() {
            $('#TableVariables')
                .append(
                    $(document.createElement('tr'))
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('button'))
                                        .attr('title', '刪除')
                                        .addClass('btn btn-warning btn-circle btn-xs')
                                        .append(
                                            $(document.createElement('i'))
                                                .addClass('fa fa-times')
                                        )
                                        .click(function () {
                                            $(this).parent().parent().remove();
                                        })
                                )
                        )
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('div'))
                                        .append($(document.createElement('input'))
                                            .attr('name', 'Name')
                                            .css({
                                                'word-break': 'break-all',
                                                'border': 0
                                            })
                                        )
                                )
                        )
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('div'))
                                        .append($(document.createElement('input'))
                                            .attr('name', 'Content')
                                            .css({
                                                'word-break': 'break-all',
                                                'border': 0
                                            })
                                        )
                                )
                        )
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('div'))
                                        .append($(document.createElement('input'))
                                            .attr('name', 'Description')
                                            .css({
                                                'word-break': 'break-all',
                                                'border': 0
                                            })
                                        )
                                )
                        )
                );
        }

        function AddMessage() {
            $('#TableMessages')
                .append(
                    $(document.createElement('tr'))
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('button'))
                                        .attr('title', '刪除')
                                        .addClass('btn btn-warning btn-circle btn-xs')
                                        .append(
                                            $(document.createElement('i'))
                                                .addClass('fa fa-times')
                                        )
                                        .click(function () {
                                            $(this).parent().parent().remove();
                                        })
                                )
                        )
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('div'))
                                        .append($(document.createElement('input'))
                                            .attr('name', 'MessageID')
                                            .css({
                                                'word-break': 'break-all',
                                                'border': 0
                                            })
                                        )
                                )
                        )
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('div'))
                                        .append($(document.createElement('textarea'))
                                            .attr('name', 'Content')
                                            .attr('cols', 26)
                                            .attr('rows', 2)
                                            .css({
                                                'word-break': 'break-all',
                                                'border': 0,
                                                'width': '100%',
                                                'resize': 'none'
                                            })
                                        )
                                )
                        )
                );
        }

        function AddHeader() {
            $('#TableHeaders')
                .append(
                    $(document.createElement('tr'))
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('button'))
                                        .attr('title', '刪除')
                                        .addClass('btn btn-warning btn-circle btn-xs')
                                        .append(
                                            $(document.createElement('i'))
                                                .addClass('fa fa-times')
                                        )
                                        .click(function () {
                                            $(this).parent().parent().remove();
                                        })
                                )
                        )
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('div'))
                                        .append($(document.createElement('input'))
                                            .attr('name', 'Name')
                                            .css({
                                                'word-break': 'break-all',
                                                'border': 0
                                            })
                                        )
                                )
                        )
                        .append(
                            $(document.createElement('td'))
                                .append(
                                    $(document.createElement('div'))
                                        .append($(document.createElement('input'))
                                            .attr('name', 'Value')
                                            .css({
                                                'word-break': 'break-all',
                                                'border': 0
                                            })
                                        )
                                )
                        )
                );
        }

        function ReplaceMessage(target, locale) {
            var start = -1;
            var end = -1;
            for (var index = 0; index < target.length; index++) {
                if (target.substr(index, 1) == '{') {
                    start = index;
                } else if (target.substr(index, 1) == '}') {
                    end = index;
                    var message_id = target.substr(start + 1, end - start - 1);
                    if (Locales[locale][message_id]) {
                        target = target.replace('{' + message_id + '}', Locales[locale][message_id]);
                    }
                    start = -1;
                    end = -1;
                }
            }
            return target;
        }

        function ReplaceVariable(target) {
            var start = -1;
            var end = -1;
            for (var index = 0; index < target.length; index++) {
                if (target.substr(index, 1) == '%') {
                    if (start == -1) {
                        start = index;
                    } else {
                        end = index;
                        var variable = target.substr(start + 1, end - start - 1);
                        if (Variables.containsKey(variable)) {
                            target = target.replace('%' + variable + '%', '<span class="text-primary">【' + Variables.get(variable).description) + '】</span>';
                        }
                        start = -1;
                        end = -1;
                    }
                }
            }
            return target;
        }

        function CreateContent(Dialog, Mode) {
            if (Dialog.type == 'text') {
                var $Text;
                if (Dialog.prompt && Dialog.prompt.indexOf('{') > -1) {
                    $Text = ReplaceMessage(Dialog.prompt, Locale);
                } else {
                    $Text = Dialog.prompt;
                }
                if ($Text.indexOf('%') > -1) {
                    $Text = ReplaceVariable($Text);
                }
                var $Element = $('' +
                    '<div class="wc-message wc-message-from-bot">' +
                    '    <div class="wc-message-content">' +
                    '        <svg class="wc-message-callout">' +
                    '            <path class="point-left" d="m0,6 l6 6 v-12 z"></path>' +
                    '            <path class="point-right" d="m6,6 l-6 6 v-12 z"></path>' +
                    '        </svg>' +
                    '        <div>' +
                    '            <span class="format-markdown">' +
                    '                <p>' +
                    '                    <span><div name="Prompt">' + $Text + '</div></span>' +
                    '                </p>' +
                    '            </span>' +
                    '        </div>' +
                    '    </div>' +
                    '</div>');
                if (Mode == 'Edit') {
                    $Element
                        .find('div[name="Prompt"]')
                        .attr('Original', Dialog.prompt)
                        .click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            $(this).addClass('border-highlight');
                            $('#TemplateText').removeClass('hidden');
                            $('#TemplateText').find('[name="Prompt"]').val($(this).attr('Original'));
                            TargetDialogItem = { Type: 'dialog.prompt' };
                        });
                }
                return $Element;
            } else if (Dialog.type == 'input') {
                var $Text;
                if (Dialog.prompt.indexOf('{') > -1) {
                    $Text = ReplaceMessage(Dialog.prompt, Locale);
                } else {
                    $Text = Dialog.prompt;
                }
                if ($Text.indexOf('%') > -1) {
                    $Text = ReplaceVariable($Text);
                }
                var $Element = $('' +
                    '<div class="wc-message wc-message-from-bot">' +
                    '    <div class="wc-message-content">' +
                    '        <svg class="wc-message-callout">' +
                    '            <path class="point-left" d="m0,6 l6 6 v-12 z"></path>' +
                    '            <path class="point-right" d="m6,6 l-6 6 v-12 z"></path>' +
                    '        </svg>' +
                    '        <div>' +
                    '            <span class="format-markdown">' +
                    '                <p>' +
                    '                    <span><div name="Prompt">' + $Text + '</div></span>' +
                    '                </p>' +
                    '            </span>' +
                    '        </div>' +
                    '    </div>' +
                    '</div>');
                if (Mode == 'Edit') {
                    $Element
                        .find('div[name="Prompt"]')
                        .attr('Original', Dialog.prompt)
                        .click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            $(this).addClass('border-highlight');
                            $('#TemplateText').removeClass('hidden');
                            $('#TemplateText').find('[name="Prompt"]').val($(this).text());
                            TargetDialogItem = { Type: 'dialog.prompt' };
                        });
                }
                return $Element;
            } else if (Dialog.type == 'card') {
                var Title, Subtitle, Text;
                if (Dialog.prompt.attachments[0].content.title && Dialog.prompt.attachments[0].content.title.indexOf('{') > -1) {
                    Title = ReplaceMessage(Dialog.prompt.attachments[0].content.title, Locale);
                } else {
                    Title = Dialog.prompt.attachments[0].content.title;
                }
                if (Title.indexOf('%') > -1) {
                    Title = ReplaceVariable(Title);
                }
                if (Dialog.prompt.attachments[0].content.subtitle && Dialog.prompt.attachments[0].content.subtitle.indexOf('{') > -1) {
                    Subtitle = ReplaceMessage(Dialog.prompt.attachments[0].content.subtitle, Locale);
                } else {
                    Subtitle = Dialog.prompt.attachments[0].content.subtitle;
                }
                if (Subtitle.indexOf('%') > -1) {
                    Subtitle = ReplaceVariable(Subtitle);
                }
                if (Dialog.prompt.attachments[0].content.text && Dialog.prompt.attachments[0].content.text.indexOf('{') > -1) {
                    Text = ReplaceMessage(Dialog.prompt.attachments[0].content.text, Locale);
                } else {
                    Text = Dialog.prompt.attachments[0].content.title;
                }
                if (Text.indexOf('%') > -1) {
                    Text = ReplaceVariable(Text);
                }
                var $Element = $('' +
                    '<div class="wc-message wc-message-from-bot">' +
                    '    <div class="wc-message-content">' +
                    '        <svg class="wc-message-callout">' +
                    '            <path class="point-left" d="m0,6 l6 6 v-12 z"></path>' +
                    '            <path class="point-right" d="m6,6 l-6 6 v-12 z"></path>' +
                    '        </svg>' +
                    '        <div>' +
                    '            <div class="wc-list">' +
                    '                <div class="wc-card hero">' +
                    '                    <h1><div name="Title">' + Title + '</div></h1>' +
                    '                    <h2><div name="Subtitle">' + Subtitle + '</div></h2>' +
                    '                    <ul class="wc-card-buttons">' +
                    '                    </ul>' +
                    '                </div>' +
                    '            </div>' +
                    '        </div>' +
                    '    </div>' +
                    '</div>');
                if (Mode == 'Edit') {
                    $Element
                        .find('div[name="Title"]')
                        .attr('Original', Dialog.prompt.attachments[0].content.title)
                        .click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            $(this).addClass('border-highlight');
                            $('#TemplateText').removeClass('hidden');
                            $('#TemplateText').find('[name="Prompt"]').val($(this).attr('Original'));
                            TargetDialogItem = { Type: 'dialog.content.title' };
                        });
                    $Element
                        .find('div[name="Subtitle"]')
                        .attr('Original', Dialog.prompt.attachments[0].content.subtitle)
                        .click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            $(this).addClass('border-highlight');
                            $('#TemplateText').removeClass('hidden');
                            $('#TemplateText').find('[name="Prompt"]').val($(this).attr('Original'));
                            TargetDialogItem = { Type: 'dialog.content.subtitle' };
                        });
                }
                if (Dialog.prompt.attachments[0].content.images) {
                    for (var Idx = 0; Idx < Dialog.prompt.attachments[0].content.images.length; Idx++) {
                        var $Image;
                        if (Dialog.prompt.attachments[0].content.images[Idx].url.indexOf('%') > -1) {
                            $Image = $('<div name="Image' + Idx + '"><img src="../../images/variable.png" style="width: 64px"></image></div>');
                        } else {
                            $Image = $('<div name="Image' + Idx + '"><img src="' + Dialog.prompt.attachments[0].content.images[Idx].url + '"></image></div>');
                        }
                        $Element
                            .find('div[class="wc-card hero"]')
                            .prepend($Image);
                        if (Mode == 'Edit') {
                            $Image.click(function () {
                                $('[id^="Template"').addClass('hidden');
                                $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                                var $Image = $('#TxtDialog').find('div[name="Image' + this.Index + '"]');
                                $Image.addClass('border-highlight');
                                $('#TemplateImage').removeClass('hidden');
                                var Image = TargetDialog.prompt.attachments[0].content.images[this.Index];
                                $('#TemplateImage').find('[name="Url"]').val(Image.url);
                                TargetDialogItem = { Type: 'dialog.content.image', Index: this.Index };
                            }.bind({ Index: Idx }));
                        }
                    }
                } else {
                    var $Image = $('<div name="Image1"><img src="../../images/no-image.png"></image></div>');
                    $Element
                        .find('div[class="wc-card hero"]')
                        .prepend($Image);
                    if (Mode == 'Edit') {
                        $Image.click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            var $Image = $('#TxtDialog').find('div[name="Image1"]');
                            $Image.addClass('border-highlight');
                            $('#TemplateImage').removeClass('hidden');
                            TargetDialogItem = { Type: 'dialog.content.image', Index: 1 };
                        });
                    }
                }
                return $Element;
            } else if (Dialog.type == 'choice') {
                var Title, Subtitle, Text;
                if (Dialog.prompt.attachments[0].content.title && Dialog.prompt.attachments[0].content.title.indexOf('{') > -1) {
                    Title = ReplaceMessage(Dialog.prompt.attachments[0].content.title, Locale);
                    // Title = Locales[Locale][Dialog.prompt.attachments[0].content.title.message_id];
                } else {
                    Title = Dialog.prompt.attachments[0].content.title;
                }
                if (Title.indexOf('%') > -1) {
                    Title = ReplaceVariable(Title);
                }
                if (Dialog.prompt.attachments[0].content.subtitle && Dialog.prompt.attachments[0].content.subtitle.indexOf('{') > -1) {
                    Subtitle = ReplaceMessage(Dialog.prompt.attachments[0].content.subtitle, Locale);
                    // Subtitle = Locales[Locale][Dialog.prompt.attachments[0].content.subtitle.message_id];
                } else {
                    Subtitle = Dialog.prompt.attachments[0].content.subtitle;
                }
                if (Subtitle.indexOf('%') > -1) {
                    Subtitle = ReplaceVariable(Subtitle);
                }
                if (Dialog.prompt.attachments[0].content.text && Dialog.prompt.attachments[0].content.text.indexOf('{') > -1) {
                    Text = ReplaceMessage(Dialog.prompt.attachments[0].content.text, Locale);
                    // Text = Locales[Locale][Dialog.prompt.attachments[0].content.text.message_id];
                } else {
                    Text = Dialog.prompt.attachments[0].content.title;
                }
                if (Text.indexOf('%') > -1) {
                    Text = ReplaceVariable(Text);
                }
                var $Element = $('' +
                    '<div class="wc-message wc-message-from-bot">' +
                    '    <div class="wc-message-content">' +
                    '        <svg class="wc-message-callout">' +
                    '            <path class="point-left" d="m0,6 l6 6 v-12 z"></path>' +
                    '            <path class="point-right" d="m6,6 l-6 6 v-12 z"></path>' +
                    '        </svg>' +
                    '        <div>' +
                    '            <div class="wc-list">' +
                    '                <div class="wc-card hero">' +
                    '                    <h1><div name="Title">' + Title + '</div></h1>' +
                    '                    <h2><div name="Subtitle">' + Subtitle + '</div></h2>' +
                    '                    <ul class="wc-card-buttons">' +
                    '                    </ul>' +
                    '                </div>' +
                    '            </div>' +
                    '        </div>' +
                    '    </div>' +
                    '</div>');
                if (Mode == 'Edit') {
                    $Element
                        .find('div[name="Title"]')
                        .attr('Original', Dialog.prompt.attachments[0].content.title)
                        .click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            $(this).addClass('border-highlight');
                            $('#TemplateText').removeClass('hidden');
                            $('#TemplateText').find('[name="Prompt"]').val($(this).attr('Original'));
                            TargetDialogItem = { Type: 'dialog.content.title' };
                        });
                    $Element
                        .find('div[name="Subtitle"]')
                        .attr('Original', Dialog.prompt.attachments[0].content.subtitle)
                        .click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            $(this).addClass('border-highlight');
                            $('#TemplateText').removeClass('hidden');
                            $('#TemplateText').find('[name="Prompt"]').val($(this).attr('Original'));
                            TargetDialogItem = { Type: 'dialog.content.subtitle' };
                        });
                }
                if (Dialog.prompt.attachments[0].content.images) {
                    for (var Idx = 0; Idx < Dialog.prompt.attachments[0].content.images.length; Idx++) {
                        var $Image;
                        if (Dialog.prompt.attachments[0].content.images[Idx].url.indexOf('%') > -1) {
                            $Image = $('<div name="Image' + Idx + '"><img src="../../images/variable.png" style="width: 64px"></image></div>');
                        } else {
                            $Image = $('<div name="Image' + Idx + '"><img src="' + Dialog.prompt.attachments[0].content.images[Idx].url + '"></image></div>');
                        }
                        $Element
                            .find('div[class="wc-card hero"]')
                            .prepend($Image);
                        if (Mode == 'Edit') {
                            $Image.click(function () {
                                $('[id^="Template"').addClass('hidden');
                                $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                                var $Image = $('#TxtDialog').find('div[name="Image' + this.Index + '"]');
                                $Image.addClass('border-highlight');
                                $('#TemplateImage').removeClass('hidden');
                                var Image = TargetDialog.prompt.attachments[0].content.images[this.Index];
                                $('#TemplateImage').find('[name="Url"]').val(Image.url);
                                TargetDialogItem = { Type: 'dialog.content.image', Index: this.Index };
                            }.bind({ Index: Idx }));
                        }
                    }
                } else {
                    var $Image = $('<div name="Image1"><img src="../../images/no-image.png"></image></div>');
                    $Element
                        .find('div[class="wc-card hero"]')
                        .prepend($Image);
                    if (Mode == 'Edit') {
                        $Image.click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            var $Image = $('#TxtDialog').find('div[name="Image1"]');
                            $Image.addClass('border-highlight');
                            $('#TemplateImage').removeClass('hidden');
                            TargetDialogItem = { Type: 'dialog.content.image', Index: 1 };
                        });
                    }
                }
                if (Dialog.prompt.attachments[0].content.buttons) {
                    for (var Idx = 0; Idx < Dialog.prompt.attachments[0].content.buttons.length; Idx++) {
                        var $Li = $('<li></li>');
                        var $Button = $('<button name="Button' + Idx + '"></button>');
                        var dialog_id;
                        $Button.text(ReplaceMessage(Dialog.prompt.attachments[0].content.buttons[Idx].title, Locale));
                        if (Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id == -2 || Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id == -3) {
                            dialog_id = Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id;
                        } else {
                            for (var Idy = 0; Idy < Dialogs.length; Idy++) {
                                if (Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id == Dialogs[Idy].dialog_uuid) {
                                    dialog_id = Dialogs[Idy].dialog_id;
                                    break;
                                }
                            }
                        }
                        if (!Mode) {
                            $Button.text($Button.text() + ' (' + dialog_id + ')');
                        }
                        $Button = $('<div name="Button' + Idx + '"></div>').append($Button);
                        $Button.attr('dialog_id', dialog_id);
                        $Button.click(function () {
                            if (Mode == 'Edit') {
                                $('#BtnRemoveButton').show();
                                var $Button = $('#TxtDialog').find('div[name="Button' + this.Index + '"]');
                                $('[id^="Template"').addClass('hidden');
                                $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                                $Button.addClass('border-highlight');
                                $('#TemplateButton').removeClass('hidden');
                                $('#TemplateButton').attr('mode', 'edit');
                                var Button = TargetDialog.prompt.attachments[0].content.buttons[this.Index];
                                $('#TemplateButton').find('[name="Title"]').val(Button.title);
                                $('#TemplateButton').find('[name="Value"]').val(Button.value);
                                $('#TemplateButton').find('[name="DialogID"]').val(Button.dialog_id);
                                TargetDialogItem = { Type: 'dialog.content.button', Index: this.Index };
                            } else {
                                // 雖然是在 DIV 定義 Click 事件，但從 event 抓到的物件卻是 Button
                                location.href = '#' + $(event.srcElement).parent().attr('dialog_id');
                                $('#TableDialogs tr')
                                    .eq(parseInt($(event.srcElement).parent().attr('dialog_id')) + 1)
                                    .animate({
                                        opacity: 0.5
                                    }, 200, function () {
                                        $('#TableDialogs tr').animate({
                                            opacity: 1
                                        }, 200);
                                    });
                            }
                            return false;
                        }.bind({ Index: Idx }));
                        $Li.append($Button);
                        $Element
                            .find('ul[class="wc-card-buttons"]')
                            .append($Li);
                    }
                }
                if (Mode == 'Edit') {
                    var $Li = $('<li></li>');
                    var $Button = $('<button name="Button' + Idx + '"></button>');
                    $Button.text('新增按鈕');
                    $Button = $('<div name="Button' + Idx + '"></div>').append($Button);
                    $Button.click(function () {
                        $('#BtnRemoveButton').hide();
                        var $Button = $('#TxtDialog').find('div[name="Button' + this.Index + '"]');
                        $('[id^="Template"').addClass('hidden');
                        $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                        $Button.addClass('border-highlight');
                        $('#TemplateButton').removeClass('hidden');
                        $('#TemplateButton').attr('mode', 'add');
                        var Button = { title: '按鈕文字', value: '回傳值', dialog_id: 0, type: 'postBack' };
                        $('#TemplateButton').find('[name="Title"]').val(Button.title);
                        $('#TemplateButton').find('[name="Value"]').val(Button.value);
                        $('#TemplateButton').find('[name="DialogID"]').val(Button.dialog_id);
                        TargetDialogItem = { Type: 'dialog.content.button', Index: this.Index };
                        return false;
                    }.bind({ Index: Idx }));
                    $Li.append($Button);
                    $Element
                        .find('ul[class="wc-card-buttons"]')
                        .append($Li);
                }
                return $Element;
            } else if (Dialog.type == 'confirm') {
                var Text;
                if (Dialog.prompt.attachments[0].content.text && Dialog.prompt.attachments[0].content.text.indexOf('{') > -1) {
                    Text = ReplaceMessage(Dialog.prompt.attachments[0].content.text, Locale);
                } else {
                    Text = Dialog.prompt.attachments[0].content.text;
                }
                if (Text.indexOf('%') > -1) {
                    Text = ReplaceVariable(Text);
                }
                var $Element = $('' +
                    '<div class="wc-message wc-message-from-bot">' +
                    '    <div class="wc-message-content">' +
                    '        <svg class="wc-message-callout">' +
                    '            <path class="point-left" d="m0,6 l6 6 v-12 z"></path>' +
                    '            <path class="point-right" d="m6,6 l-6 6 v-12 z"></path>' +
                    '        </svg>' +
                    '        <div>' +
                    '            <div class="wc-list">' +
                    '                <div class="wc-card hero">' +
                    '                    <p><div name="Title">' + Text + '</div></p>' +
                    '                    <ul class="wc-card-buttons">' +
                    '                    </ul>' +
                    '                </div>' +
                    '            </div>' +
                    '        </div>' +
                    '    </div>' +
                    '</div>');
                if (Mode == 'Edit') {
                    $Element
                        .find('div[name="Title"]')
                        .attr('Original', Dialog.prompt.attachments[0].content.text)
                        .click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            $(this).addClass('border-highlight');
                            $('#TemplateText').removeClass('hidden');
                            $('#TemplateText').find('[name="Prompt"]').val($(this).attr('Original'));
                            TargetDialogItem = { Type: 'dialog.content.text' };
                        });
                }
                if (Dialog.prompt.attachments[0].content.images) {
                    for (var Idx = 0; Idx < Dialog.prompt.attachments[0].content.images.length; Idx++) {
                        var $Image;
                        if (Dialog.prompt.attachments[0].content.images[Idx].url.indexOf('%') > -1) {
                            $Image = $('<div name="Image' + Idx + '"><img src="../../images/variable.png" style="width: 64px"></image></div>');
                        } else {
                            $Image = $('<div name="Image' + Idx + '"><img src="' + Dialog.prompt.attachments[0].content.images[Idx].url + '"></image></div>');
                        }
                        $Element
                            .find('div[class="wc-card hero"]')
                            .prepend($Image);
                        if (Mode == 'Edit') {
                            $Image.click(function () {
                                $('[id^="Template"').addClass('hidden');
                                $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                                var $Image = $('#TxtDialog').find('div[name="Image' + this.Index + '"]');
                                $Image.addClass('border-highlight');
                                $('#TemplateImage').removeClass('hidden');
                                var Image = TargetDialog.prompt.attachments[0].content.images[this.Index];
                                $('#TemplateImage').find('[name="Url"]').val(Image.url);
                                TargetDialogItem = { Type: 'dialog.content.image', Index: this.Index };
                            }.bind({ Index: Idx }));
                        }
                    }
                } else {
                    var $Image = $('<div name="Image1"><img src="../../images/no-image.png"></image></div>');
                    $Element
                        .find('div[class="wc-card hero"]')
                        .prepend($Image);
                    if (Mode == 'Edit') {
                        $Image.click(function () {
                            $('[id^="Template"').addClass('hidden');
                            $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                            var $Image = $('#TxtDialog').find('div[name="Image1"]');
                            $Image.addClass('border-highlight');
                            $('#TemplateImage').removeClass('hidden');
                            TargetDialogItem = { Type: 'dialog.content.image', Index: 1 };
                        });
                    }
                }
                if (Dialog.prompt.attachments[0].content.buttons) {
                    for (var Idx = 0; Idx < Dialog.prompt.attachments[0].content.buttons.length; Idx++) {
                        var $Li = $('<li></li>');
                        var $Button = $('<button name="Button' + Idx + '"></button>');
                        var dialog_id;
                        $Button.text(ReplaceMessage(Dialog.prompt.attachments[0].content.buttons[Idx].title, Locale));
                        if (Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id == -2 || Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id == -3) {
                            dialog_id = Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id;
                        } else {
                            for (var Idy = 0; Idy < Dialogs.length; Idy++) {
                                if (Dialog.prompt.attachments[0].content.buttons[Idx].dialog_id == Dialogs[Idy].dialog_uuid) {
                                    dialog_id = Dialogs[Idy].dialog_id;
                                    break;
                                }
                            }
                        }
                        if (!Mode) {
                            $Button.text($Button.text() + ' (' + dialog_id + ')');
                        }
                        $Button = $('<div name="Button' + Idx + '"></div>').append($Button);
                        $Button.attr('dialog_id', dialog_id);
                        $Button.click(function () {
                            if (Mode == 'Edit') {
                                $('#BtnRemoveButton').show();
                                var $Button = $('#TxtDialog').find('div[name="Button' + this.Index + '"]');
                                $('[id^="Template"').addClass('hidden');
                                $('#TxtDialog').find('.border-highlight').removeClass('border-highlight');
                                $Button.addClass('border-highlight');
                                $('#TemplateButton').removeClass('hidden');
                                $('#TemplateButton').attr('mode', 'edit');
                                var Button = TargetDialog.prompt.attachments[0].content.buttons[this.Index];
                                $('#TemplateButton').find('[name="Title"]').val(Button.title);
                                $('#TemplateButton').find('[name="Value"]').val(Button.value);
                                $('#TemplateButton').find('[name="DialogID"]').val(Button.dialog_id);
                                TargetDialogItem = { Type: 'dialog.content.button', Index: this.Index };
                            } else {
                                // 雖然是在 DIV 定義 Click 事件，但從 event 抓到的物件卻是 Button 
                                location.href = '#' + $(event.srcElement).parent().attr('dialog_id');
                                $('#TableDialogs tr')
                                    .eq(parseInt($(event.srcElement).parent().attr('dialog_id')) + 1)
                                    .animate({
                                        opacity: 0.5
                                    }, 200, function () {
                                        $('#TableDialogs tr').animate({
                                            opacity: 1
                                        }, 200);
                                    });
                            }
                            return false;
                        }.bind({ Index: Idx }));
                        $Li.append($Button);
                        $Element
                            .find('ul[class="wc-card-buttons"]')
                            .append($Li);
                    }
                }
                return $Element;
            } else if (Dialog.type == 'condition') {
                if (Mode != 'Edit') {
                    var Html = '<div>';
                    Html = Html + '當<span class="text-primary">【' + Variables.get(Dialog.condition.field).description + '】</span>';
                    switch (Dialog.condition.type) {
                        case '0': Html = Html + '<mark>小於</mark>'; break;
                        case '1': Html = Html + '<mark>小於等於</mark>'; break;
                        case '2': Html = Html + '<mark>等於</mark>'; break;
                        case '3': Html = Html + '<mark>大於等於</mark>'; break;
                        case '4': Html = Html + '<mark>大於</mark>'; break;
                    }
                    switch (Dialog.condition.target_type) {
                        case '0': Html = Html + '【' + Dialog.condition.target_field + '】，'; break;
                        case '1': Html = Html + '<span class="text-primary">【' + Variables.get(Dialog.condition.target_field).description + '】</span>，'; break;
                    }

                    var success_dialog_id, fail_dialog_id;
                    if (Dialog.condition.success_dialog_id > 0) {
                        for (var Idx = 0; Idx < Dialogs.length; Idx++) {
                            if (Dialog.condition.success_dialog_id == Dialogs[Idx].dialog_uuid) success_dialog_id = Dialogs[Idx].dialog_id;
                        }
                    } else {
                        success_dialog_id = Dialog.condition.success_dialog_id;
                    }
                    if (Dialog.condition.fail_dialog_id > 0) {
                        for (var Idx = 0; Idx < Dialogs.length; Idx++) {
                            if (Dialog.condition.fail_dialog_id == Dialogs[Idx].dialog_uuid) fail_dialog_id = Dialogs[Idx].dialog_id;
                        }
                    } else {
                        fail_dialog_id = Dialog.condition.fail_dialog_id;
                    }

                    Html = Html + '<mark>是</mark>則轉跳至對話框【' + GetDialogName(success_dialog_id) + '】，';
                    Html = Html + '<mark>否</mark>則轉跳至對話框【' + GetDialogName(fail_dialog_id) + '】';
                    Html = Html + '</div>';
                    return Html;
                }
            } else if (Dialog.type == 'operate') {
                if (Mode != 'Edit') {
                    return Dialog.operate.replace(/\n/g, '<br />');
                }
            } else if (Dialog.type == 'webapi') {
                if (Mode != 'Edit') {
                    var Html = Dialog.webapi.protocol + '://' + Dialog.webapi.host + ':' + Dialog.webapi.port + '/' + Dialog.webapi.path;
                    var start = -1;
                    var end = -1;
                    for (var index = 0; index < Html.length; index++) {
                        if (Html.substr(index, 1) == '%') {
                            if (start == -1) {
                                start = index;
                            } else {
                                end = index;
                                var variable = Html.substr(start + 1, end - start - 1);
                                if (Variables.containsKey(variable)) {
                                    Html = Html.replace('%' + variable + '%', '<span class="text-primary">【' + Variables.get(variable).description + '】</span>');
                                }
                                start = -1;
                                end = -1;
                            }
                        }
                    }
                    return Html;
                }
            } else if (Dialog.type == 'qna_maker') {
                if (Mode != 'Edit') {
                    return '用  ' + ReplaceVariable(Dialog.qna_maker.problem, Locale) + ' 詢問 QnA Maker';
                }
            }
        }

        function GetDialogName(DialogID) {
            if (DialogID == -2) {
                return "服務結束";
            } else if (DialogID == -3) {
                return "客服專線";
            } else {
                for (var idx = 0; idx < Dialogs.length; idx++) {
                    if (Dialogs[idx].dialog_uuid == DialogID) {
                        return Dialogs[idx].description;
                    }
                }
            }
            return '未知';
        }

        function ApplyText() {
            var Prompt = $('#TemplateText').find('[name="Prompt"]').val();
            if (TargetDialogItem.Type == 'dialog.prompt') {
                TempDialog.prompt = Prompt;
            } else if (TargetDialogItem.Type == 'dialog.content.title') {
                TempDialog.prompt.attachments[0].content.title = Prompt;
            } else if (TargetDialogItem.Type == 'dialog.content.subtitle') {
                TempDialog.prompt.attachments[0].content.subtitle = Prompt;
            } else if (TargetDialogItem.Type == 'dialog.content.text') {
                TempDialog.prompt.attachments[0].content.text = Prompt;
            }
            $('#TxtDialog').html(CreateContent(TempDialog, 'Edit'));
            $('#TemplateText').addClass('hidden');
        }

        function ApplyButton() {
            if (TargetDialogItem.Type == 'dialog.content.button') {
                if ($('#TemplateButton').attr('mode') == 'edit') {
                    TempDialog.prompt.attachments[0].content.buttons[TargetDialogItem.Index].title = $('#TemplateButton').find('[name="Title"]').val();
                    TempDialog.prompt.attachments[0].content.buttons[TargetDialogItem.Index].dialog_id = $('#TemplateButton').find('[name="DialogID"]').val();
                    TempDialog.prompt.attachments[0].content.buttons[TargetDialogItem.Index].value = $('#TemplateButton').find('[name="Value"]').val();
                } else {
                    if (TempDialog.prompt.attachments[0].content.buttons == undefined) {
                        TempDialog.prompt.attachments[0].content.buttons = [];
                    }
                    TempDialog.prompt.attachments[0].content.buttons.push({
                        title: $('#TemplateButton').find('[name="Title"]').val(),
                        dialog_id: $('#TemplateButton').find('[name="DialogID"]').val(),
                        value: $('#TemplateButton').find('[name="Value"]').val(),
                        type: 'postBack'
                    });
                }
            }
            $('#TxtDialog').html(CreateContent(TempDialog, 'Edit'));
            $('#TemplateButton').addClass('hidden');
        }

        function RemoveButton() {
            if (TargetDialogItem.Type == 'dialog.content.button') {
                if (TempDialog.prompt.attachments[0].content.buttons.length == 1) {
                    ShowMessage('只剩下一個按鈕時無法刪除');
                    return;
                }
                TempDialog.prompt.attachments[0].content.buttons.splice(TargetDialogItem.Index, 1);
            }
            $('#TxtDialog').html(CreateContent(TempDialog, 'Edit'));
            $('#TemplateImage').addClass('hidden');
        }

        function ApplyImage() {
            if (TargetDialogItem.Type == 'dialog.content.image') {
                if (TempDialog.prompt.attachments[0].content.images) {
                    if ($('#TemplateImage').find('[name="Url"]').val() == '') {
                        ShowMessage('圖片網址無效');
                        return;
                    } else {
                        TempDialog.prompt.attachments[0].content.images[TargetDialogItem.Index].url = $('#TemplateImage').find('[name="Url"]').val();
                    }
                } else {
                    if ($('#TemplateImage').find('[name="Url"]').val() == '') {
                        ShowMessage('圖片網址無效');
                        return;
                    } else {
                        TempDialog.prompt.attachments[0].content.images = [];
                        TempDialog.prompt.attachments[0].content.images.push({ url: $('#TemplateImage').find('[name="Url"]').val() });
                    }
                }
            }
            $('#TxtDialog').html(CreateContent(TempDialog, 'Edit'));
            $('#TemplateImage').addClass('hidden');
        }

        function RemoveImage() {
            if (TargetDialogItem.Type == 'dialog.content.image') {
                TempDialog.prompt.attachments[0].content.images = undefined;
            }
            $('#TxtDialog').html(CreateContent(TempDialog, 'Edit'));
            $('#TemplateImage').addClass('hidden');
        }

        function Loading() {
            bootbox.dialog({
                message: '請稍後',
                title: '',
                closeButton: false
            });
        }

        function Loaded() {
            bootbox.hideAll();
        }

        function ShowMessage(Message, Callback) {
            bootbox.alert({
                message: Message,
                title: ''
            });
            if (typeof (Callback) == 'function') {
                Callback();
            }
        }

        function guid() {
            function S4() {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            }
            return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
        }

        function split(val, string) {
            return val.split(string);
        }

        function extractLast(term, string) {
            return split(term, string).pop();
        }
    </script>
</head>

<body>
    <div id="wrapper">
        <div id="page-wrapper">
            <div class="row" style="position: relative">
                <div class="col-lg-12">
                    <h1 name="title" class="page-header">對話流程編輯器－</h1>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading" style="height: 60px">
                        <div class="pull-left">
                            <div class="btn-group">
                                <select id="SelLocale" class="form-control">
                                    <option value='tw'>中文</option>
                                    <option value='cn'>簡中</option>
                                    <option value='en'>英文</option>
                                </select>
                            </div>
                        </div>
                        <div class="pull-right">
                            <button type="button" id="BtnView" title="檢視流程圖" class="btn btn-success btn-sm">
                                <i class="fa fa-eye"></i>
                            </button>
                            <button type="button" id="BtnMessage" title="訊息編號" class="btn btn-primary btn-sm">
                                <i class="fa fa-comments-o"></i>
                            </button>
                            <button type="button" id="BtnVariable" title="參數" class="btn btn-primary btn-sm">
                                <i class="fa fa-pencil-square"></i>
                            </button>
                            <button type="button" id="BtnAdd" title="新增" class="btn btn-success btn-sm">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover" id="TableDialogs">
                                <thead>
                                    <tr>
                                        <th style="width: 20px"></th>
                                        <th style="width: 20px"></th>
                                        <th style="width: 50px"></th>
                                        <th style="width: 80px">類型</th>
                                        <th>內容</th>
                                        <th style="width: 50px">前往</th>
                                        <th style="width: 150px">寫入變數</th>
                                        <th style="width: 150px">描述</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Dialog Modal -->
    <div class="modal modal-wide fade" id="DialogModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="DialogForm" role="form">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 id="ModalTitle" class="modal-title"></h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <input class="form-control hidden" id="TxtRecordDialogID" name="RecordDialogID">
                                </div>
                                <div class="form-group">
                                    <input class="form-control hidden" id="TxtUniqueDialogID" name="UniqueDialogID">
                                </div>
                                <div class="form-group">
                                    <span class="fa fa-asterisk"></span>
                                    <label>對話框編號：</label>
                                    <input class="form-control" id="TxtDialogID" name="DialogID">
                                    <select class="form-control" id="TxtExistedDialogID" name="ExistedDialogID"></select>
                                </div>
                                <div class="form-group">
                                    <label>變數：</label>
                                    <select class="form-control" id="TxtField" name="Field" disabled>
                                        <option value="">無</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label>類型：</label>
                                    <select class="form-control" id="TxtType" name="Type">
                                        <option value="text">文字</option>
                                        <option value="card">圖文</option>
                                        <option value="input">輸入</option>
                                        <option value="choice">選單</option>
                                        <option value="confirm">確認視窗</option>
                                        <option value="condition">判斷式</option>
                                        <option value="operate">運算式</option>
                                        <option value="webapi">WEB API</option>
                                        <option value="qna_maker">QnA Maker</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <span class="fa fa-asterisk"></span>
                                    <label>描述：</label>
                                    <input class="form-control" id="TxtDescription" name="Description">
                                </div>
                            </div>
                            <div class="col-lg-6" id="DivNext">
                                <div class="form-group">
                                    <label>轉跳對話框：</label>
                                    <select class="form-control" id="TxtNext" name="Next">
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6" id="DivTransfer">
                                <div class="form-group">
                                    <label>轉接技能群組：</label>
                                    <select class="form-control" id="TxtSkill" name="Skill">
                                        <option value="DEFAULT">預設群組</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-12 hidden" id="DivDialog">
                                <div class="form-group">
                                    <label>預覽：</label>
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <div class="col-lg-6">
                                                <div id="TxtDialog" name="Dialog"></div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div id="TemplateText" class="hidden">
                                                    <label>文字：</label>
                                                    <div class="ui-widget">
                                                        <input type="text" name="Prompt" class="form-control auto_complete"></input>
                                                    </div>
                                                    <br>
                                                    <div class="pull-right">
                                                        <button type="button" class="btn btn-success" onclick="ApplyText();">套用</button>
                                                    </div>
                                                </div>
                                                <div id="TemplateButton" class="hidden">
                                                    <label>按鈕文字：</label>
                                                    <div class="ui-widget">
                                                        <input type="text" name="Title" class="form-control auto_complete"></input>
                                                    </div>
                                                    <label>轉跳對話框：</label>
                                                    <!--<input type="text" name="DialogID" class="form-control"></input>-->
                                                    <select name="DialogID" class="form-control">
                                                    </select>
                                                    <label>回傳值：</label>
                                                    <div class="ui-widget">
                                                        <input type="text" name="Value" class="form-control auto_complete"></input>
                                                    </div>
                                                    <br>
                                                    <div class="pull-right">
                                                        <button type="button" class="btn btn-danger" id="BtnRemoveButton" onclick="RemoveButton();">移除按鈕</button>
                                                        <button type="button" class="btn btn-success" onclick="ApplyButton();">套用</button>
                                                    </div>
                                                </div>
                                                <div id="TemplateImage" class="hidden">
                                                    <label>圖片網址：</label>
                                                    <input type="text" name="Url" class="form-control"></input>
                                                    <br>
                                                    <div class="pull-right">
                                                        <button type="button" class="btn btn-danger" onclick="RemoveImage();">移除圖片</button>
                                                        <button type="button" class="btn btn-success" onclick="ApplyImage();">套用</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12 hidden" id="DivCondition">
                                <div class="form-group">
                                    <label>判斷式：</label>
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="form-group col-lg-6">
                                                    <label>目標變數</label>
                                                    <select name="Field" class="form-control">
                                                    </select>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <label>判斷式：</label>
                                                    <select name="Type" class="form-control">
                                                        <option value="0">小於</option>
                                                        <option value="1">小於等於</option>
                                                        <option value="2">等於</option>
                                                        <option value="3">大於等於</option>
                                                        <option value="4">大於</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <label>比對標的類型</label>
                                                    <select name="TargetType" class="form-control">
                                                        <option value="Const">常式</option>
                                                        <option value="Variable">變數</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <label>比對標的</label>
                                                    <input name="TargetField" class="form-control"></input>
                                                    <select name="TargetField" class="form-control hidden">
                                                    </select>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <label>判斷式成立時，轉跳對話框：</label>
                                                    <select name="SuccessDialog" class="form-control"></select>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <label>判斷式不成立時，轉跳對話框：</label>
                                                    <select name="FailDialog" class="form-control"></select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12 hidden" id="DivOperate">
                                <div class="form-group">
                                    <label>運算式：</label>
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="form-group col-lg-12">
                                                    <label>指定內容</label>
                                                    <textarea name="Operate" class="form-control" rows="5">
                                                        </textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12 hidden" id="DivWebAPI">
                                <div class="form-group">
                                    <label>Web API：</label>
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="form-group col-lg-12">
                                                    <table class="row">
                                                        <tr>
                                                            <td>
                                                                <select name="Method" class="form-control">
                                                                    <option value="get">GET</option>
                                                                    <option value="post">POST</option>
                                                                    <option value="put">PUT</option>
                                                                    <option value="delete">DELETE</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <select name="Protocol" class="form-control">
                                                                    <option value="http">HTTP</option>
                                                                    <option value="https">HTTPS</option>
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <label>&nbsp;://&nbsp;</label>
                                                                </dtdiv>
                                                                <td>
                                                                    <input name="Host" class="form-control"></input>
                                                                </td>
                                                                <td>
                                                                    <label>&nbsp;:&nbsp;</label>
                                                                </td>
                                                                <td>
                                                                    <input name="Port" class="form-control"></input>
                                                                </td>
                                                                <td>
                                                                    <label>&nbsp;/&nbsp;</label>
                                                                </td>
                                                                <td>
                                                                    <input name="Path" class="form-control"></input>
                                                                </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <br />
                                                                <button type="button" class="btn btn-success hidden" id="BtnParams">參數設定</button>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-12 hidden" id="DivQnAMaker">
                                <div class="form-group">
                                    <label>QnA Maker：</label>
                                    <div class="panel panel-default">
                                        <div class="panel-body">
                                            <div class="row">
                                                <div class="form-group col-lg-6">
                                                    <label>Code：</label>
                                                    <input name="Code" class="form-control"></input>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <label>Key：</label>
                                                    <input name="Key" class="form-control"></input>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="form-group col-lg-6">
                                                    <label>問題：</label>
                                                    <input name="Problem" class="form-control"></input>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="submit" id="BtnSave" class="btn btn-primary">儲存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Variable Modal -->
    <div class="modal modal-middle fade" id="VariableModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">參數設定</h4>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="TableVariables">
                            <thead>
                                <tr>
                                    <th style="width: 20px"></th>
                                    <th style="width: 100px">名稱</th>
                                    <th style="width: 100px">內容</th>
                                    <th style="width: 150px">描述</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pull-right">
                        <button type="button" id="BtnAddVariable" title="新增" class="btn btn-success btn-xs">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="submit" id="BtnSaveVariable" class="btn btn-primary">儲存</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Locale Modal -->
    <div class="modal modal-middle fade" id="MessageModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">訊息設定</h4>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="TableMessages">
                            <thead>
                                <tr>
                                    <th style="width: 20px"></th>
                                    <th style="width: 100px">編號</th>
                                    <th style="width: 150px">內容</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pull-right">
                        <button type="button" id="BtnAddMessage" title="新增" class="btn btn-success btn-xs">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="submit" id="BtnSaveMessage" class="btn btn-primary">儲存</button>
                </div>
            </div>
        </div>
    </div>
    <!-- POST Modal -->
    <div class="modal modal-middle fade" id="PostModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title">POST 參數設定</h4>
                </div>
                <div class="modal-body">
                    <span>HEADER</span>
                    <div class="table-responsive">
                        <table class="table table-bordered" id="TableHeaders">
                            <thead>
                                <tr>
                                    <th style="width: 20px"></th>
                                    <th style="width: 100px">名稱</th>
                                    <th style="width: 100px">內容</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pull-right">
                        <button type="button" id="BtnAddHeader" title="新增" class="btn btn-success btn-xs">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                    <br />
                    <span>BODY</span>
                    <div>
                        <textarea rows="5" name="Body" class="form-control" style="resize: none"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="submit" id="BtnSavePost" class="btn btn-primary">儲存</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>